rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 管理員判斷
    function getAdminData() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             getAdminData().isActive == true;
    }

    // 檢查管理員是否被授權訪問特定聯盟
    function isAuthorizedForAlliance(alliance) {
      let adminData = getAdminData();
      return adminData.isActive == true && (
        adminData.allowedAlliances == null || 
        adminData.allowedAlliances.hasAny(['*']) || 
        alliance in adminData.allowedAlliances
      );
    }
    
    // 2. 管理員文件
    match /admins/{adminId} {
      allow read: if request.auth != null && (request.auth.uid == adminId || isAdmin());
      allow list: if isAdmin();
      allow write: if false;
    }
    
    // 3. 使用者資料集合
    match /users/{userId} {
      // 讀取：管理員需具備該聯盟權限
      allow read: if request.auth != null && (
        !exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || 
        (resource != null && isAuthorizedForAlliance(resource.data.alliance))
      );
      
      // 建立：管理員需具備新資料聯盟權限
      allow create: if request.auth != null && 
          (
            !exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || 
            isAuthorizedForAlliance(request.resource.data.alliance)
          ) &&
          request.resource.data.gameId is string &&
          request.resource.data.alliance is string &&
          request.resource.data.team1Power is number &&
          request.resource.data.team2Power is number &&
          request.resource.data.team3Power is number &&
          request.resource.data.updatedAt is timestamp &&
          request.resource.data.submittedAt is timestamp;

      // 更新：管理員需同時具備「舊聯盟」與「新聯盟」的權限 (防止越權移動)
      allow update: if request.auth != null && 
          (
            !exists(/databases/$(database)/documents/admins/$(request.auth.uid)) || 
            (isAuthorizedForAlliance(resource.data.alliance) && isAuthorizedForAlliance(request.resource.data.alliance))
          ) &&
          request.resource.data.gameId is string &&
          request.resource.data.alliance is string &&
          request.resource.data.team1Power is number &&
          request.resource.data.team2Power is number &&
          request.resource.data.team3Power is number &&
          request.resource.data.updatedAt is timestamp &&
          request.resource.data.submittedAt is timestamp;

      // 刪除：只有具備權限的管理員可以刪
      allow delete: if isAdmin() && isAuthorizedForAlliance(resource.data.alliance);
    }
  }
}