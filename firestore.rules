rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. 管理員判斷 (保留你原本的邏輯)
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isActive == true;
    }
    
    // 2. 管理員文件 (解開死鎖 ✨)
    match /admins/{adminId} {
      // 允許登入者讀取自己的管理員文件 (checkIsAdmin 才能跑)
      allow read: if request.auth != null && request.auth.uid == adminId;
      // 只有管理員可以列出所有人
      allow list: if isAdmin();
      allow write: if false;
    }
    
    // 3. 使用者資料集合 (關鍵修改 ✨)
    match /users/{userId} {
      // 讀取：允許所有人讀取 (這樣盟友才能看到自己的預覽或排行)
      // 如果想更嚴格，可以改成 allow read: if request.auth != null;
      allow read: if request.auth != null;
      
      // 寫入：保留你原本超棒的驗證邏輯 (支援小數點 number)
      allow create, update: if request.auth != null && 
          request.resource.data.gameId is string &&
          request.resource.data.alliance is string &&
          request.resource.data.team1Power is number &&
          request.resource.data.team2Power is number &&
          request.resource.data.team3Power is number &&
          request.resource.data.updatedAt is timestamp &&
          request.resource.data.submittedAt is timestamp;

      // 刪除：只有管理員可以刪
      allow delete: if isAdmin();
    }
  }
}